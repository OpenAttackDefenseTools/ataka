from rich import print
from rich.markup import escape

from ..util import dt_to_local_str, highlight_flags, blueify, redify, magentify, greenify, yellowfy, ERROR_STR

EXECUTION_STATUS_IS_FINAL = {'finished', 'failed', 'timeout', 'cancelled'}

EXECUTION_STATUS_COLOR = {
    'queued': magentify,
    'running': blueify,
    'finished': greenify,
    'failed': redify,
    'timeout': yellowfy,
    'cancelled': redify,
}


def print_exploit_execution(job, execution):
    exe_desc = f'execution {execution["id"]} of job {job["id"]}'

    status = execution['status']
    status_note = ' (not finished, check back later)' if status not in EXECUTION_STATUS_IS_FINAL else ''

    print(f'--- Begin {exe_desc} ---')
    print(f'Status    : {EXECUTION_STATUS_COLOR[status](status)}{status_note}')
    print(f'Exploit   : {job["exploit_id"]}')
    print(f'Target    : {execution["target"]["ip"]} ({execution["target"]["service"]})')
    print(f'Timestamp : {dt_to_local_str(job["timestamp"])}')

    if execution['stdout']:
        for line in escape(execution['stdout']).splitlines():
            print(f"    {highlight_flags(line, blueify)}")
        print()

    if execution['stderr']:
        for line in escape(execution['stderr']).splitlines():
            print(f"{ERROR_STR} {highlight_flags(line, blueify)}")

    print(f'--- End {exe_desc} ---')
    print()
